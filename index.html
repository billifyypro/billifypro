<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Console | Billify</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030712; --sidebar: #0b0f19; --card: #111827; --border: #1f2937;
            --primary: #6366f1; --primary-glow: rgba(99, 102, 241, 0.15);
            --text-main: #f9fafb; --text-muted: #9ca3af; --success: #10b981; --warning: #f59e0b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* AUTH & MODALS */
        #auth-overlay, #preview-modal { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        #preview-modal { background: rgba(0,0,0,0.95); display:none; flex-direction: column; }
        .auth-box { width: 100%; max-width: 400px; background: var(--sidebar); padding: 32px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 0 50px rgba(99, 102, 241, 0.1); }
        .auth-header { text-align: center; margin-bottom: 24px; }
        .auth-toggle { display: flex; background: var(--card); padding: 4px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border); }
        .t-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); transition: 0.3s; }
        .t-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .form-group { margin-bottom: 16px; } label { display: block; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 6px; }

        /* LAYOUT */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; z-index: 50; }
        .logo { font-size: 1.4rem; font-weight: 800; color: white; margin-bottom: 40px; display: flex; align-items: center; gap: 12px; }
        .nav-item { padding: 12px 16px; margin-bottom: 6px; border-radius: 12px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 12px; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); border-color: rgba(99, 102, 241, 0.2); }
        .main { flex: 1; padding: 32px; overflow-y: auto; position: relative; }
        .page { display: none; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); } .page.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 24px; border-radius: 20px; position: relative; transition: 0.3s; }
        .card:hover { border-color: #374151; transform: translateY(-4px); }
        
        /* THEME CARDS */
        .theme-img { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; cursor: zoom-in; }
        .theme-check { position: absolute; top: 15px; right: 15px; width: 25px; height: 25px; accent-color: var(--success); cursor: pointer; transform: scale(1.5); }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 0.95rem; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-yellow { background: var(--warning); color: black; }
        input { width: 100%; background: #030712; border: 1px solid var(--border); padding: 14px; color: white; border-radius: 12px; margin-bottom: 0; outline: none; }
        
        /* CHAT */
        .chat-fab { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px var(--primary-glow); z-index: 90; font-size: 24px; cursor: pointer; }
        .chat-box { display: none; position: fixed; bottom: 100px; right: 30px; width: 300px; height: 400px; background: var(--sidebar); border: 1px solid var(--border); border-radius: 16px; z-index: 91; flex-direction: column; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 8px; align-self: flex-end; max-width: 80%; font-size: 0.9rem; }

        /* MODAL */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: var(--sidebar); width: 90%; max-width: 420px; padding: 30px; border-radius: 24px; border: 1px solid var(--border); }
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(11, 15, 25, 0.9); backdrop-filter: blur(12px); border-top: 1px solid var(--border); z-index: 100; padding: 12px; justify-content: space-between; }
        .b-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.7rem; gap: 4px; padding: 5px; }
        .b-item.active { color: var(--primary); }

        @media (max-width: 768px) { .sidebar { display: none; } .bottom-nav { display: flex; } .main { padding: 24px 20px 100px 20px; } .chat-fab { bottom: 80px; right: 20px; width: 50px; height: 50px; font-size: 20px; } .chat-box { bottom: 140px; right: 20px; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <div class="auth-header">
                <h2 style="color:white; margin:0 0 10px;">Billify Pro</h2>
                <p style="color:var(--text-muted); margin:0;">Login or Signup to continue</p>
            </div>
            <div class="auth-toggle">
                <div id="t-login" class="t-btn active" onclick="toggleAuth('login')">Login</div>
                <div id="t-signup" class="t-btn" onclick="toggleAuth('signup')">Sign Up</div>
            </div>
            <div id="form-login">
                <div class="form-group"><label>Username</label><input id="l-user"></div>
                <div class="form-group"><label>Password</label><input type="password" id="l-pass"></div>
                <button class="btn" onclick="doLogin()">Login</button>
            </div>
            <div id="form-signup" style="display:none;">
                <div class="form-group"><label>Username</label><input id="s-user"></div>
                <div class="grid" style="gap:10px; grid-template-columns:1fr 1fr; margin-bottom:15px;"><div><label>Name</label><input id="s-name"></div><div><label>Mobile</label><input id="s-mobile"></div></div>
                <div class="form-group"><label>Email</label><input id="s-email"></div>
                <div class="grid" style="gap:10px; grid-template-columns:1fr 1fr; margin-bottom:15px;"><div><label>Pass</label><input type="password" id="s-pass"></div><div><label>Confirm</label><input type="password" id="s-pass2"></div></div>
                <button class="btn" onclick="doSignup()">Create Account</button>
            </div>
        </div>
    </div>

    <div id="preview-modal">
        <div style="width:90%; height:90%; position:relative;">
            <button onclick="document.getElementById('preview-modal').style.display='none'" style="position:absolute; top:-40px; right:0; background:red; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">Close</button>
            <img id="prev-img" style="width:100%; height:100%; object-fit:contain; border-radius:12px;">
        </div>
    </div>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-bolt" style="color:var(--primary)"></i> Billify Pro</div>
        <div class="nav-item active" onclick="nav('home')"><i class="fa-solid fa-grid-2"></i> Dashboard</div>
        <div class="nav-item" onclick="nav('orders')"><i class="fa-solid fa-receipt"></i> My Orders</div>
        <div class="nav-item" onclick="nav('plans')"><i class="fa-solid fa-rocket"></i> Membership</div>
        <div class="nav-item" onclick="nav('designs')"><i class="fa-solid fa-palette"></i> Themes</div>
        <div class="nav-item" onclick="nav('profile')"><i class="fa-solid fa-user-gear"></i> Settings</div>
        <div class="nav-item" style="margin-top:auto; color:#ef4444;" onclick="logout()"><i class="fa-solid fa-sign-out"></i> Logout</div>
    </div>

    <div class="chat-fab" onclick="toggleChat()"><i class="fa-solid fa-comment-dots"></i></div>
    <div id="chat-box" class="chat-box">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">Support <i class="fa-solid fa-xmark" onclick="toggleChat()"></i></div>
        <div id="chat-msgs" class="chat-msgs"></div>
        <div style="padding:10px; display:flex; gap:5px;"><input id="chat-in" placeholder="Message..."><button class="btn" style="width:auto; margin:0;" onclick="sendMsg()">></button></div>
    </div>

    <div class="main">
        <div id="pg-home" class="page active">
            <h2>Dashboard</h2>
            <div id="design-alert" style="display:none; padding:15px; background:rgba(99,102,241,0.1); border:1px solid var(--primary); border-radius:12px; color:var(--primary); margin-bottom:20px;">
                <i class="fa-solid fa-check-circle"></i> Selected Theme: <b id="da-name">None</b>
            </div>
            <div id="active-subs" class="grid"></div>
            <h3 style="margin-top:40px; border-bottom:1px solid var(--border); padding-bottom:10px;">My Websites</h3>
            <div id="web-list" class="grid"></div>
        </div>

        <div id="pg-orders" class="page">
            <h2>My Orders</h2>
            <div id="my-order-list" class="grid">Loading orders...</div>
        </div>

        <div id="pg-plans" class="page"><h2>Plans</h2><div id="free-trial-container" style="margin-bottom:30px;"></div><div id="plans-container" class="grid"></div></div>

        <div id="pg-designs" class="page">
            <h2>Themes & Categories</h2>
            <button id="back-cat" class="btn btn-outline" style="width:auto; display:none; margin-bottom:15px;" onclick="loadCategories()">< Back to Categories</button>
            <div id="design-grid" class="grid">Loading...</div>
        </div>

        <div id="pg-profile" class="page">
            <div class="card" style="max-width:500px">
                <h3>Settings</h3>
                <label>Full Name</label><input id="p-name">
                <label>Mobile</label><input id="p-mobile">
                <label style="color:var(--primary)">Payment Name (Required)</label><input id="p-payname">
                <hr style="border-color:var(--border); margin:20px 0;">
                <label>Email (Read-only)</label><input id="p-email" readonly style="opacity:0.6">
                <label>Password</label><input id="p-pass" readonly style="opacity:0.6">
                <button class="btn" onclick="saveProfile()">Update</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="b-item active" onclick="nav('home')"><i class="fa-solid fa-house"></i> Home</div>
        <div class="b-item" onclick="nav('orders')"><i class="fa-solid fa-receipt"></i> Orders</div>
        <div class="b-item" onclick="nav('plans')"><i class="fa-solid fa-gem"></i> Plans</div>
        <div class="b-item" onclick="nav('designs')"><i class="fa-solid fa-brush"></i> Themes</div>
        <div class="b-item" onclick="nav('profile')"><i class="fa-solid fa-user"></i> Profile</div>
    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="m-title" style="margin-top:0">Order Summary</h3>
            <div style="background:#030712; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; color:var(--text-muted);"><span>Plan</span> <b id="m-plan" style="color:white"></b></div>
                <div style="display:flex; justify-content:space-between; font-size:1.1rem; margin-top:5px;"><span>Total</span> <b style="color:var(--success)">₹<span id="m-price"></span></b></div>
            </div>
            <div id="step-1">
                <input id="m-site" placeholder="Website Name" style="margin-bottom:12px">
                <button class="btn" onclick="toStep2()">Proceed to Pay</button>
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            </div>
            <div id="step-2" style="display:none; text-align:center;">
                <img id="qr-img" style="width:180px; height:180px; margin:0 auto 15px; display:block; background:white; padding:5px; border-radius:12px;">
                <p style="color:var(--text-muted);">Scan & Pay ₹<span id="m-price-2"></span></p>
                <input id="m-txn" placeholder="Transaction ID (UTR)">
                <button class="btn" onclick="submitOrder()">Confirm Order</button>
                <button class="btn btn-outline" onclick="document.getElementById('step-2').style.display='none'; document.getElementById('step-1').style.display='block'">Back</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCX5qpT_ytgJjRk21-VWZ-Ndhbq0hhjXYo", authDomain: "fir-integration-61a1f.firebaseapp.com", databaseURL: "https://fir-integration-61a1f-default-rtdb.firebaseio.com", projectId: "fir-integration-61a1f", storageBucket: "fir-integration-61a1f.firebasestorage.app", messagingSenderId: "178334018866", appId: "1:178334018866:web:ef78bc307549639d0ebb2b" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let uid = null, tempOrder={}, selectedDesign=null;
        let isRenew=false, renewId=null;

        window.onload = () => {
            const u = localStorage.getItem('billify_user');
            if(u){ uid = u; document.getElementById('auth-overlay').style.display='none'; initApp(); }
        };

        function toggleAuth(t){
            document.querySelectorAll('.t-btn').forEach(b=>b.classList.remove('active')); document.getElementById('t-'+t).classList.add('active');
            document.getElementById('form-login').style.display = t==='login'?'block':'none';
            document.getElementById('form-signup').style.display = t==='signup'?'block':'none';
        }
        function doLogin(){
            const u=document.getElementById('l-user').value.toLowerCase().trim(), p=document.getElementById('l-pass').value;
            if(!u||!p) return alert("Fill all");
            db.ref('users/'+u).once('value',s=>{
                if(s.exists() && s.val().password===p){ uid=u; localStorage.setItem('billify_user',uid); document.getElementById('auth-overlay').style.display='none'; initApp(); }
                else alert("Invalid credentials");
            });
        }
        function doSignup(){
            const u=document.getElementById('s-user').value.toLowerCase().trim().replace(/\s/g,''), e=document.getElementById('s-email').value, p=document.getElementById('s-pass').value;
            if(!u||!e||!p || p.length<8 || !e.includes('@')) return alert("Invalid inputs (Pass 8+, Valid Email)");
            db.ref('users/'+u).once('value',s=>{
                if(s.exists()) return alert("Taken");
                db.ref('users/'+u).set({ username:u, password:p, profile:{name:document.getElementById('s-name').value, mobile:document.getElementById('s-mobile').value, email:e, payName:document.getElementById('s-name').value} })
                .then(()=>{ alert("Created"); toggleAuth('login'); });
            });
        }
        function logout(){ localStorage.removeItem('billify_user'); location.reload(); }

        function initApp(){ loadSubs(); loadPlans(); loadCategories(); loadProfile(); loadHistory(); checkFreeTrial(); loadMyOrders(); }
        function nav(id){
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav-item, .b-item').forEach(n=>n.classList.remove('active'));
            document.getElementById('pg-'+id).classList.add('active');
            const idx=['home','orders','plans','designs','profile'].indexOf(id);
            if(idx>-1){ document.querySelectorAll('.nav-item')[idx].classList.add('active'); document.querySelectorAll('.b-item')[idx].classList.add('active'); }
        }

        // --- THEMES & CATEGORIES ---
        function loadCategories(){
            document.getElementById('back-cat').style.display='none';
            db.ref('categories').on('value',s=>{
                const e=document.getElementById('design-grid'); e.innerHTML='';
                if(s.exists()) s.forEach(c=>{
                    e.innerHTML+=`<div class="card" onclick="loadThemes('${c.key}')" style="cursor:pointer; padding:15px;">
                        <img src="${c.val().image}" style="width:100%; height:160px; object-fit:cover; border-radius:12px; margin-bottom:10px;">
                        <h3 style="margin:0; text-align:center;">${c.val().name}</h3>
                    </div>`;
                });
                else e.innerHTML='<p>No categories.</p>';
            });
        }
        function loadThemes(catId){
            document.getElementById('back-cat').style.display='inline-block';
            db.ref('themes').orderByChild('categoryId').equalTo(catId).on('value',s=>{
                const e=document.getElementById('design-grid'); e.innerHTML='';
                if(s.exists()) s.forEach(c=>{
                    const t=c.val();
                    const isSel = selectedDesign === t.name;
                    e.innerHTML+=`<div class="card" style="padding:15px;">
                        <input type="checkbox" class="theme-check" ${isSel?'checked':''} onclick="selectTheme('${t.name}', this)">
                        <img src="${t.image}" class="theme-img" onclick="showPreview('${t.image}')">
                        <b style="font-size:1.1rem">${t.name}</b>
                        <a href="${t.url}" target="_blank" style="display:block; color:var(--primary); margin-top:5px; font-size:0.9rem">Live Demo</a>
                    </div>`;
                });
                else e.innerHTML='<p>No themes in this category.</p>';
            });
        }
        function selectTheme(name, cb){
            document.querySelectorAll('.theme-check').forEach(c=>c.checked=false);
            cb.checked=true; selectedDesign=name;
            document.getElementById('design-alert').style.display='flex'; document.getElementById('da-name').innerText=name;
        }
        function showPreview(img){ document.getElementById('preview-modal').style.display='flex'; document.getElementById('prev-img').src=img; }

        // --- MY ORDERS ---
        function loadMyOrders(){
            db.ref('subscriptions').orderByChild('uid').equalTo(uid).on('value',s=>{
                const e=document.getElementById('my-order-list'); e.innerHTML='';
                if(s.exists()){
                    const arr=[]; s.forEach(c=>arr.push(c.val()));
                    arr.reverse().forEach(o=>{
                        e.innerHTML+=`<div class="card">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <b style="color:var(--primary)">${o.orderId||'N/A'}</b>
                                <span style="background:${o.status==='active'?'var(--success)':'var(--warning)'}; color:black; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">${o.status.toUpperCase()}</span>
                            </div>
                            <h3 style="margin:0 0 5px 0;">${o.websiteName}</h3>
                            <div style="font-size:0.9rem; color:var(--text-muted);">
                                Plan: ${o.planName} (₹${o.price})<br>
                                Txn ID: ${o.txnId}<br>
                                Theme: ${o.selectedDesign || 'Standard'}
                            </div>
                        </div>`;
                    });
                } else e.innerHTML='<p style="text-align:center; color:#666">No orders found.</p>';
            });
        }

        // --- CHAT ---
        function toggleChat(){ const b=document.getElementById('chat-box'); b.style.display=b.style.display==='flex'?'none':'flex'; if(b.style.display==='flex') loadMsgs(); }
        function sendMsg(){
            const m=document.getElementById('chat-in').value; if(!m)return;
            db.ref('support_chats').push({user:uid, username:uid, message:m, timestamp:Date.now()});
            document.getElementById('chat-in').value='';
        }
        function loadMsgs(){
            db.ref('support_chats').orderByChild('user').equalTo(uid).limitToLast(20).on('value',s=>{
                const d=document.getElementById('chat-msgs'); d.innerHTML='';
                if(s.exists()) { s.forEach(c=>{ d.innerHTML+=`<div class="msg-bubble">${c.val().message}</div>`; }); d.scrollTop=d.scrollHeight; }
            });
        }

        // --- SUBSCRIPTIONS WITH RENEW ---
        function loadSubs(){ 
            db.ref('subscriptions').orderByChild('uid').equalTo(uid).on('value',s=>{
                const e=document.getElementById('active-subs'); e.innerHTML='';
                if(s.exists()) s.forEach(c=>{
                    const sub = c.val();
                    if(sub.status==='active') {
                        const daysLeft = Math.ceil((sub.expiryDate - Date.now())/86400000);
                        const expDate = new Date(sub.expiryDate).toLocaleDateString();
                        const showRenew = sub.price && parseInt(sub.price) > 0;
                        
                        e.innerHTML+=`<div class="card" style="background:linear-gradient(145deg, #1f2937, #111827);">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <b style="color:var(--success)">ACTIVE</b><br>
                                    <h3>${sub.websiteName}</h3>
                                    <small>Plan: ${sub.planName} | ID: ${sub.orderId}</small>
                                </div>
                                <div style="text-align:right;">
                                    <b style="color:white; font-size:1.2rem;">${daysLeft}</b><br><small style="color:var(--text-muted)">Days Left</small>
                                </div>
                            </div>
                            <div style="margin:10px 0; font-size:0.9rem; color:var(--text-muted);">Expires on: ${expDate}</div>
                            <div style="display:flex; gap:10px;">
                                <a href="${sub.websiteUrl}" target="_blank" class="btn btn-outline" style="margin:0; text-decoration:none;">Open</a>
                                ${showRenew ? `<button class="btn btn-yellow" style="margin:0;" onclick="openBuy('${sub.planName}','${sub.price}','${sub.durationDays}', true, '${c.key}', '${sub.websiteName}')">Renew</button>` : ''}
                            </div>
                        </div>`;
                    }
                });
            }); 
        }

        function loadPlans(){ db.ref('plans').on('value',s=>{const e=document.getElementById('plans-container'); e.innerHTML=''; if(s.exists())s.forEach(c=>{const p=c.val(); e.innerHTML+=`<div class="card"><h3>${p.name}</h3><p style="color:#999">${p.desc||''}</p><h1>₹${p.price}</h1><button class="btn" onclick="openBuy('${p.name}','${p.price}','${p.days}', false)">Select</button></div>`})}); }
        function checkFreeTrial(){ db.ref('users/'+uid).on('value',s=>{ const u=s.val()||{}; document.getElementById('free-trial-container').innerHTML=u.freeUsed?`<div class="card" style="opacity:0.5; border:1px dashed #333">Free Trial Claimed</div>`:`<div class="card free-card" style="border-color:var(--success)"><b style="color:var(--success)">GIFT: Free Trial</b><br><input id="free-name" placeholder="Site Name" style="margin-top:10px"><button class="btn" style="width:auto" onclick="claimFree()">Launch Demo</button></div>`; }); }
        async function claimFree(){ const n=document.getElementById('free-name').value; if(!n)return; const u=(await db.ref('settings/autoFreeUrl').get()).val(); db.ref('websites').push({owner:uid,name:n,url:u||'',status:u?'live':'processing'}); db.ref('users/'+uid).update({freeUsed:true}); alert("Done"); nav('home'); }
        function loadHistory(){ db.ref('websites').orderByChild('owner').equalTo(uid).on('value',s=>{ const e=document.getElementById('web-list'); e.innerHTML=''; if(s.exists())s.forEach(c=>e.innerHTML+=`<div class="card" style="padding:15px;"><b>${c.val().name}</b> <a href="${c.val().url}" target="_blank" style="float:right; color:white">Open</a></div>`) }); }
        
        async function openBuy(n,p,d,renew,key,site){
            const prof = (await db.ref('users/'+uid+'/profile').get()).val();
            if(!prof || !prof.payName) { alert("Setup Profile first"); nav('profile'); return; }
            tempOrder={n,p,d}; isRenew=renew; renewId=key;
            
            document.getElementById('m-title').innerText = renew ? "Renew Plan" : "New Order";
            document.getElementById('m-plan').innerText=n; document.getElementById('m-price').innerText=p; document.getElementById('m-price-2').innerText=p;
            
            const si=document.getElementById('m-site');
            if(renew){ si.value=site; si.readOnly=true; } else { si.value=""; si.readOnly=false; }

            document.getElementById('modal-overlay').style.display='flex'; document.getElementById('step-1').style.display='block'; document.getElementById('step-2').style.display='none';
        }
        function toStep2(){ if(!document.getElementById('m-site').value) return; db.ref('settings/qrCodeUrl').once('value',s=>{ document.getElementById('qr-img').src=s.val()||''; document.getElementById('step-1').style.display='none'; document.getElementById('step-2').style.display='block'; }); }
        
        function submitOrder(){
            const txn=document.getElementById('m-txn').value; if(!txn)return;
            // RE-FETCH PROFILE TO BE SAFE
            db.ref('users/'+uid+'/profile').once('value', s=>{
                const p = s.val();
                const d = {
                    uid:uid, 
                    orderId:'ORD-'+Math.floor(100000+Math.random()*900000),
                    name:p.name, mobile:p.mobile, payerName:p.payName,
                    planName:tempOrder.n, price:tempOrder.p, durationDays:tempOrder.d,
                    websiteName:document.getElementById('m-site').value, selectedDesign:selectedDesign||'Standard', txnId:txn, orderDate:Date.now()
                };
                
                if(isRenew){
                    d.type = 'renewal'; d.originalSubId = renewId; d.status = 'pending'; // Added status for consistency
                    db.ref('renewals').push(d);
                } else {
                    d.status = 'pending';
                    db.ref('subscriptions').push(d);
                }
                
                alert("Order Placed!"); document.getElementById('modal-overlay').style.display='none';
            });
        }
        function closeModal(){ document.getElementById('modal-overlay').style.display='none'; }
        
        function saveProfile(){ db.ref('users/'+uid+'/profile').update({name:document.getElementById('p-name').value, mobile:document.getElementById('p-mobile').value, payName:document.getElementById('p-payname').value}).then(()=>alert("Saved")); }
        function loadProfile(){ db.ref('users/'+uid).once('value',s=>{ if(s.exists()){ const u=s.val(); const p=u.profile||{}; document.getElementById('p-name').value=p.name||''; document.getElementById('p-mobile').value=p.mobile||''; document.getElementById('p-payname').value=p.payName||''; document.getElementById('p-email').value=p.email||''; document.getElementById('p-pass').value=u.password||''; } }); }

    </script>
</body>
</html>